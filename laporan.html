<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Pengambilan MBG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-success shadow-sm mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">LAPORAN MBG</span>
            <a href="index.html" class="btn btn-light btn-sm">Kembali</a>
        </div>
    </nav>

    <div class="container" id="laporan-container">
        <!-- Tabel laporan per kategori akan diisi oleh JS -->
    </div>

    <script>
        // Reset data pengambilan jika ganti hari (otomatis reset laporan)
        const now = new Date();
        const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        const lastDate = localStorage.getItem('last_date');
        if (lastDate !== today) {
            localStorage.setItem('pengambilan', JSON.stringify([]));
            localStorage.setItem('last_date', today);
        }

        function loadLaporan() {
            const warga = JSON.parse(localStorage.getItem('warga')) || [];
            const pengambilan = JSON.parse(localStorage.getItem('pengambilan')) || [];
            const container = document.getElementById('laporan-container');
            container.innerHTML = '';

            const categories = ['Ibu Hamil', 'Busui', 'Balita'];

            // Gabungkan data pengambilan dengan nama warga
            const dataFull = pengambilan.map(p => {
                const w = warga.find(w => w.id === p.warga_id) || { nama: 'Warga Terhapus', nik: '-', kategori: 'Lainnya' };
                return { ...p, ...w };
            });

            categories.forEach(cat => {
                const filteredData = dataFull.filter(item => item.kategori === cat);
                // Urutkan berdasarkan waktu terbaru
                filteredData.sort((a, b) => new Date(b.waktu_ambil) - new Date(a.waktu_ambil));

                if (filteredData.length > 0) {
                    const card = document.createElement('div');
                    card.className = 'card shadow-sm border-0 mb-4';
                    card.innerHTML = `
                        <div class="card-header bg-white py-2">
                            <h6 class="mb-0 fw-bold text-success text-uppercase small">${cat}</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr style="font-size: 0.8rem;">
                                            <th class="ps-3">No</th>
                                            <th>Warga</th>
                                            <th>Waktu Pengambilan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredData.map((item, index) => {
                                            const dateObj = new Date(item.waktu_ambil);
                                            const tgl = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                                            const jam = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                                            return `
                                                <tr>
                                                    <td class="ps-3 text-muted small">${index + 1}</td>
                                                    <td>
                                                        <div class="fw-bold small">${item.nama}</div>
                                                        <small class="text-muted" style="font-size: 0.7rem;">${item.nik}</small>
                                                    </td>
                                                    <td>
                                                        <div class="fw-bold text-success small">${tgl}</div>
                                                        <small class="text-muted" style="font-size: 0.7rem;">${jam} WIB</small>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                }
            });

            if (dataFull.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">Belum ada data pengambilan.</div>';
            }
        }

        loadLaporan();
    </script>
</body>
</html>
