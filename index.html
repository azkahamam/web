<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi MBG Desa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary shadow-sm mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">MBG DESA</span>
            <div class="d-flex">
                <a href="tambah_warga.html" class="btn btn-success btn-sm me-2">+ Warga</a>
                <a href="laporan.html" class="btn btn-light btn-sm">Laporan</a>
            </div>
        </div>
    </nav>

    <div class="container mb-3">
        <h5 class="mb-0 text-primary fw-bold text-center" id="current-date">
            Absensi: ...
        </h5>
    </div>

    <div class="container" id="category-containers">
        <!-- Tabel per kategori akan diisi oleh JS -->
    </div>

    <script>
        const today = new Date().toISOString().split('T')[0];
        const formattedDate = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
        document.getElementById('current-date').innerText = 'Absensi: ' + formattedDate;

        function loadData() {
            const warga = JSON.parse(localStorage.getItem('warga')) || [];
            const pengambilan = JSON.parse(localStorage.getItem('pengambilan')) || [];
            const container = document.getElementById('category-containers');
            container.innerHTML = '';

            const categories = ['Ibu Hamil', 'Busui', 'Balita'];

            categories.forEach(cat => {
                const filteredWarga = warga.filter(w => w.kategori === cat);
                filteredWarga.sort((a, b) => a.nama.localeCompare(b.nama));

                if (filteredWarga.length > 0) {
                    const card = document.createElement('div');
                    card.className = 'card shadow-sm border-0 mb-4';
                    card.innerHTML = `
                        <div class="card-header bg-white py-2">
                            <h6 class="mb-0 fw-bold text-primary text-uppercase small">${cat}</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr style="font-size: 0.8rem;">
                                            <th class="ps-3">No</th>
                                            <th>Nama & NIK</th>
                                            <th class="text-center">Status</th>
                                            <th class="text-center pe-3">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredWarga.map((w, index) => {
                                            const sudahAmbil = pengambilan.some(p => p.warga_id === w.id && p.tanggal === today);
                                            return `
                                                <tr>
                                                    <td class="ps-3 text-muted small">${index + 1}</td>
                                                    <td>
                                                        <div class="fw-bold small">${w.nama}</div>
                                                        <small class="text-muted" style="font-size: 0.7rem;">${w.nik} | RT ${w.rt}/${w.rw}</small>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge rounded-pill ${sudahAmbil ? 'bg-success' : 'bg-warning text-dark'}" style="font-size: 0.65rem;">
                                                            ${sudahAmbil ? 'Sudah' : 'Belum'}
                                                        </span>
                                                    </td>
                                                    <td class="text-center pe-3">
                                                        <div class="d-flex justify-content-center gap-1">
                                                            ${!sudahAmbil ? `<button onclick="ambilMBG(${w.id})" class="btn btn-primary btn-sm px-2 py-0 small" style="font-size: 0.7rem;">Ambil</button>` : ''}
                                                            <button onclick="hapusWarga(${w.id})" class="btn btn-outline-danger btn-sm px-1 py-0 small" style="font-size: 0.7rem;">&times;</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                }
            });

            if (warga.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">Belum ada data warga.</div>';
            }
        }

        function ambilMBG(id) {
            const pengambilan = JSON.parse(localStorage.getItem('pengambilan')) || [];
            pengambilan.push({
                warga_id: id,
                tanggal: today,
                waktu_ambil: new Date().toISOString()
            });
            localStorage.setItem('pengambilan', JSON.stringify(pengambilan));
            loadData();
        }

        function hapusWarga(id) {
            if (confirm('Hapus warga ini?')) {
                let warga = JSON.parse(localStorage.getItem('warga')) || [];
                let pengambilan = JSON.parse(localStorage.getItem('pengambilan')) || [];
                
                warga = warga.filter(w => w.id !== id);
                pengambilan = pengambilan.filter(p => p.warga_id !== id);
                
                localStorage.setItem('warga', JSON.stringify(warga));
                localStorage.setItem('pengambilan', JSON.stringify(pengambilan));
                loadData();
            }
        }

        loadData();
    </script>
</body>
</html>
