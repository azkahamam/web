<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi MBG Desa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary shadow-sm mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">MBG DESA</span>
            <div class="d-flex">
                <a href="tambah_warga.html" class="btn btn-success btn-sm me-2">+ Warga</a>
                <a href="laporan.html" class="btn btn-light btn-sm">Laporan</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-primary fw-bold text-center" id="current-date">
                    Absensi: ...
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="table-absensi">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">No</th>
                                <th>Nama & NIK</th>
                                <th class="text-center">Status</th>
                                <th class="text-center pe-3">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="warga-list">
                            <!-- Data akan diisi oleh JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const today = new Date().toISOString().split('T')[0];
        const formattedDate = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
        document.getElementById('current-date').innerText = 'Absensi: ' + formattedDate;

        function loadData() {
            const warga = JSON.parse(localStorage.getItem('warga')) || [];
            const pengambilan = JSON.parse(localStorage.getItem('pengambilan')) || [];
            const list = document.getElementById('warga-list');
            list.innerHTML = '';

            warga.sort((a, b) => a.nama.localeCompare(b.nama));

            warga.forEach((w, index) => {
                const sudahAmbil = pengambilan.some(p => p.warga_id === w.id && p.tanggal === today);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="ps-3 text-muted">${index + 1}</td>
                    <td>
                        <div class="fw-bold">${w.nama}</div>
                        <div class="badge bg-info text-dark" style="font-size: 0.7rem;">${w.kategori}</div>
                        <small class="d-block text-muted">${w.nik} | RT ${w.rt}/${w.rw}</small>
                    </td>
                    <td class="text-center">
                        <span class="badge rounded-pill ${sudahAmbil ? 'bg-success' : 'bg-warning text-dark'}">
                            ${sudahAmbil ? 'Sudah' : 'Belum'}
                        </span>
                    </td>
                    <td class="text-center pe-3">
                        <div class="d-flex justify-content-center gap-1">
                            ${!sudahAmbil ? `<button onclick="ambilMBG(${w.id})" class="btn btn-primary btn-sm px-3">Ambil</button>` : ''}
                            <button onclick="hapusWarga(${w.id})" class="btn btn-outline-danger btn-sm px-2">&times;</button>
                        </div>
                    </td>
                `;
                list.appendChild(tr);
            });

            if (warga.length === 0) {
                list.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">Belum ada data warga.</td></tr>';
            }
        }

        function ambilMBG(id) {
            const pengambilan = JSON.parse(localStorage.getItem('pengambilan')) || [];
            pengambilan.push({
                warga_id: id,
                tanggal: today,
                waktu_ambil: new Date().toISOString()
            });
            localStorage.setItem('pengambilan', JSON.stringify(pengambilan));
            loadData();
        }

        function hapusWarga(id) {
            if (confirm('Hapus warga ini?')) {
                let warga = JSON.parse(localStorage.getItem('warga')) || [];
                let pengambilan = JSON.parse(localStorage.getItem('pengambilan')) || [];
                
                warga = warga.filter(w => w.id !== id);
                pengambilan = pengambilan.filter(p => p.warga_id !== id);
                
                localStorage.setItem('warga', JSON.stringify(warga));
                localStorage.setItem('pengambilan', JSON.stringify(pengambilan));
                loadData();
            }
        }

        loadData();
    </script>
</body>
</html>
